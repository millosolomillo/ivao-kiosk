<!DOCTYPE html>
<html lang="en">
	<head>
		<a href="https://github.com/millosolomillo/ivao-kiosk" class="github-corner" aria-label="View source on GitHub">
			<svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
				<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/>
				<path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
				<path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
			</svg>
		</a>
		<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
		<meta charset="UTF-8">
			<title>IVAO Live Airport Board (UTC)</title>
			<meta name="viewport" content="width=device-width, initial-scale=1">
				<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #002b7f; /* deep airport blue */
    color: #ffeb3b;      /* bright yellow text */
    font-family: 'Segoe UI', Arial, sans-serif;
  }
  header {
    padding: 20px;
    background: #001f5c;
    display: flex;
    flex-direction: column;
    align-items: center;
    border-bottom: 3px solid #ffeb3b;
  }
  h1 {
    margin: 0 0 10px;
    font-size: 2rem;
    letter-spacing: 2px;
  }
  form {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  input, button {
    padding: 8px 12px;
    font-size: 1rem;
    border: none;
    border-radius: 4px;
  }
  input {
    background: #fff;
    color: #000;
    text-transform: uppercase;
    width: 100px;
    text-align: center;
  }
  button {
    background: #ffeb3b;
    color: #000;
    font-weight: bold;
    cursor: pointer;
  }
  .meta {
    margin-top: 10px;
    font-size: 1rem;
  }
  main {
    padding: 0;
    width: 100%;
  }
  .boards {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
  }
  @media (max-width: 900px) {
    .boards { grid-template-columns: 1fr; }
  }
  h2 {
    background: #001f5c;
    margin: 0;
    padding: 10px;
    font-size: 1.2rem;
    border-bottom: 2px solid #ffeb3b;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 1.1rem;
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid #ffeb3b;
    text-align: left;
  }
  th {
    background: #001f5c;
    font-weight: bold;
  }
  tbody tr:nth-child(even) {
    background: rgba(255, 255, 255, 0.05);
  }
  tbody tr:hover {
    background: rgba(255, 255, 0, 0.2);
  }
  .muted {
    color: #ffd600;
    opacity: 0.8;
  }
  .err {
    color: #ff5252;
  }
</style>
			</head>
			<body>
				<header>
					<h1>IVAO LIVE ARRIVALS & DEPARTURES (UTC)</h1>
					<form id="controls">
						<label for="icao">Airport ICAO:</label>
						<input id="icao" maxlength="4" placeholder="EHAM" required>
						<button id="loadBtn" type="submit">Show</button>
					</form>
					<div class="meta">
						<span id="airportTitle">Airport: —</span> |
    <span id="status">Idle</span> |
    <span id="lastUpdate"/>
					</div>
				</header>
				<main>
					<div class="boards">
						<section>
							<h2>Arrivals</h2>
							<table id="arrivals">
								<thead>
									<tr>
										<th>Callsign</th>
										<th>From</th>
										<th>Aircraft</th>
										<th>Phase</th>
										<th>ETA (UTC)</th>
									</tr>
								</thead>
								<tbody/>
							</table>
						</section>
						<section>
							<h2>Departures</h2>
							<table id="departures">
								<thead>
									<tr>
										<th>Callsign</th>
										<th>To</th>
										<th>Aircraft</th>
										<th>Phase</th>
										<th>ETD (UTC)</th>
									</tr>
								</thead>
								<tbody/>
							</table>
						</section>
					</div>
				</main>
				<script>
const FEED_URL = "https://api.ivao.aero/v2/tracker/whazzup";
let currentICAO = "";
let timer = null;

const $ = s => document.querySelector(s);
const statusEl = $("#status");
const lastUpdateEl = $("#lastUpdate");

// URL parameter check for ?icao=XXXX
const params = new URLSearchParams(window.location.search);
const icaoFromURL = params.get("icao");
if (icaoFromURL) {
  $("#icao").value = icaoFromURL.toUpperCase();
  currentICAO = icaoFromURL.toUpperCase();
  $("#airportTitle").textContent = "Airport: " + currentICAO;
  startAutoRefresh(); // auto-load immediately
}

$("#controls").addEventListener("submit", (e) => {
  e.preventDefault();
  currentICAO = $("#icao").value.trim().toUpperCase();
  $("#airportTitle").textContent = "Airport: " + (currentICAO || "—");
  if (!currentICAO) return;
  startAutoRefresh();
});

function startAutoRefresh() {
  if (timer) clearInterval(timer);
  updateBoard();
  timer = setInterval(updateBoard, 60 * 1000);
}

// Convert seconds since midnight UTC to HH:MM UTC
function secondsToUTCTime(sec) {
  if (!sec || isNaN(sec)) return "-";
  const date = new Date();
  date.setUTCHours(0, 0, 0, 0);
  date.setUTCSeconds(sec);
  return date.toISOString().substr(11, 5); // HH:MM from ISO string
}

async function updateBoard() {
  if (!currentICAO) return;
  setStatus("Loading...");
  try {
    const res = await fetch(FEED_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    const pilots = data?.clients?.pilots || [];
    const arrivals = [];
    const departures = [];

    for (const p of pilots) {
      const callsign = p.callsign || "-";
      const acft = p.flightPlan?.aircraftId || "-";
      const dep = (p.flightPlan?.departureId || "").toUpperCase();
      const arr = (p.flightPlan?.arrivalId || "").toUpperCase();
      const phase = p.lastTrack?.state;
      const etd = secondsToUTCTime(p.flightPlan?.departureTime);  
      const eta = secondsToUTCTime(Math.floor(new Date(p.lastTrack?.timestamp).getTime() / 1000) + (p.lastTrack?.arrivalDistance && p.lastTrack?.groundSpeed ? Math.floor(p.lastTrack.arrivalDistance / p.lastTrack.groundSpeed * 3600) : 0));

      if (arr === currentICAO) arrivals.push({ callsign, from: dep, acft, phase, eta });
      if (dep === currentICAO) departures.push({ callsign, to: arr, acft, phase, etd });
    }

    arrivals.sort((a,b) => a.callsign.localeCompare(b.callsign));
    departures.sort((a,b) => a.callsign.localeCompare(b.callsign));

    renderRows("#arrivals tbody", arrivals, ["callsign","from","acft","phase","eta"]);
    renderRows("#departures tbody", departures, ["callsign","to","acft","phase","etd"]);

    lastUpdateEl.textContent = "Last updated (UTC): " + new Date().toUTCString().split(" ")[4];
    setStatus(`OK • ${arrivals.length} arrivals • ${departures.length} departures`);
  } catch (err) {
    console.error(err);
    setStatus("Error: " + (err.message || String(err)), true);
  }
}

function renderRows(sel, rows, fields) {
  const tbody = document.querySelector(sel);
  tbody.innerHTML = "";
  if (!rows.length) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = fields.length;
    td.className = "muted";
    td.textContent = "No matching flights";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }
  for (const r of rows) {
    const tr = document.createElement("tr");
    for (const f of fields) {
      const td = document.createElement("td");
      td.textContent = r[f] || "-";
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
}

function setStatus(msg, isErr = false) {
  statusEl.textContent = msg;
  statusEl.className = isErr ? "err" : "muted";
}
</script>
